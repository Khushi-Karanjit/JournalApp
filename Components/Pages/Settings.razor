@page "/settings"
@inject JournalApp.Services.ThemeService ThemeService
@inject JournalApp.Services.AuthService Auth
@inject JournalApp.Services.PdfExportService PdfExportService
@inject NavigationManager Nav
@inject IJSRuntime JS

<MudText Typo="Typo.h4" Class="mb-4">Settings</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudStack Spacing="3">
            <!-- Theme Settings -->
            <MudPaper Class="pa-4 rounded-xl" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-3">Theme</MudText>
                <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" OverrideStyles="false">
                    <MudButton Variant="@(IsLight ? Variant.Filled : Variant.Outlined)" OnClick="SetLight">Light Mode</MudButton>
                    <MudButton Variant="@(IsDark ? Variant.Filled : Variant.Outlined)" OnClick="SetDark">Dark Mode</MudButton>
                </MudButtonGroup>
            </MudPaper>

            <!-- Export PDF -->
            <MudPaper Class="pa-4 rounded-xl" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-3">Export PDF</MudText>
                <MudStack Spacing="2">
                    <MudDatePicker Label="Start Date" @bind-Date="exportStart" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    <MudDatePicker Label="End Date" @bind-Date="exportEnd" Variant="Variant.Outlined" Margin="Margin.Dense" />

                    @if (!string.IsNullOrWhiteSpace(exportStatus))
                    {
                        <MudText Color="@(exportStatus.Contains("Exporting") ? Color.Info : Color.Error)">@exportStatus</MudText>
                    }

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportPdf" Class="mt-2 rounded-lg" StartIcon="@Icons.Material.Filled.PictureAsPdf">Export</MudButton>
                </MudStack>
            </MudPaper>
        </MudStack>
    </MudItem>

    <!-- Change PIN -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4 rounded-xl" Elevation="0" Outlined="true">
            <MudText Typo="Typo.h6" Class="mb-3">Change PIN</MudText>
            <MudStack Spacing="2">
                <MudTextField @bind-Value="currentPin" Label="Current PIN" InputType="InputType.Password" Variant="Variant.Outlined" Margin="Margin.Dense" />
                <MudTextField @bind-Value="newPin" Label="New PIN" InputType="InputType.Password" Variant="Variant.Outlined" Margin="Margin.Dense" />
                <MudTextField @bind-Value="confirmPin" Label="Confirm New PIN" InputType="InputType.Password" Variant="Variant.Outlined" Margin="Margin.Dense" />
                
                @if (!string.IsNullOrWhiteSpace(pinStatus))
                {
                    <MudText Color="@(pinStatus.Contains("updated") ? Color.Success : Color.Error)">@pinStatus</MudText>
                }

                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ChangePin" Class="mt-2 rounded-lg">Update PIN</MudButton>
            </MudStack>
        </MudPaper>
        
    </MudItem>
</MudGrid>

@code {
    private bool IsLight => ThemeService.CurrentTheme == "light";
    private bool IsDark => ThemeService.CurrentTheme == "dark";

    private Task SetLight()
    {
        return ThemeService.SetThemeAsync("light", JS);
    }

    private Task SetDark()
    {
        return ThemeService.SetThemeAsync("dark", JS);
    }

    private string currentPin = "";
    private string newPin = "";
    private string confirmPin = "";
    private string pinStatus = "";

    private async Task ChangePin()
    {
        pinStatus = "";

        if (string.IsNullOrWhiteSpace(currentPin) ||
            string.IsNullOrWhiteSpace(newPin) ||
            string.IsNullOrWhiteSpace(confirmPin))
        {
            pinStatus = "All PIN fields are required.";
            return;
        }

        if (newPin.Trim() != confirmPin.Trim())
        {
            pinStatus = "New PINs do not match.";
            return;
        }

        var ok = await Auth.VerifyPinAsync(currentPin.Trim());
        if (!ok)
        {
            pinStatus = "Current PIN is incorrect.";
            return;
        }

        await Auth.SetPinAsync(newPin.Trim());
        currentPin = "";
        newPin = "";
        confirmPin = "";
        pinStatus = "PIN updated successfully.";
    }

    private DateTime? exportStart = DateTime.Today.AddDays(-30);
    private DateTime? exportEnd = DateTime.Today;
    private string exportStatus = "";

    private async Task ExportPdf()
    {
        if (exportStart == null || exportEnd == null)
        {
             exportStatus = "Please select start and end dates.";
             return;
        }

        if (exportEnd.Value.Date < exportStart.Value.Date)
        {
            exportStatus = "End date must be after start date.";
            return;
        }

        exportStatus = "Exporting...";
        try
        {
            var result = await PdfExportService.ExportEntriesAsync(exportStart.Value, exportEnd.Value);
            exportStatus = result.Message;
        }
        catch (Exception ex)
        {
            exportStatus = ex.Message;
        }
    }
}
