@page "/calendar"
@inject JournalApp.Services.EntryService EntryService
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.Medium" Class="page-shell">
    <MudText Typo="Typo.h4" Class="mb-3">Calendar</MudText>

    <MudPaper Class="surface-card calendar-card">

        <!-- Header INSIDE the card -->
        <div class="calendar-header">
            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                           Variant="Variant.Text"
                           Color="Color.Inherit"
                           OnClick="PrevMonth" />

            <MudText Typo="Typo.h6" Class="calendar-title">
                @_currentMonth.ToString("MMMM yyyy")
            </MudText>

            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                           Variant="Variant.Text"
                           Color="Color.Inherit"
                           OnClick="NextMonth" />
        </div>

        <!-- Weekday headers -->
        <div class="calendar-grid mb-2">
            @foreach (var day in _dayHeaders)
            {
                <div class="calendar-weekday">@day</div>
            }
        </div>

        <!-- Calendar days -->
        <div class="calendar-grid">
            @foreach (var week in _weeks)
            {
                @foreach (var date in week)
                {
                    var inMonth = date.Month == _currentMonth.Month;
                    var hasEntry = _entryDates.Contains(date.Date);
                    var classes = GetCellClass(inMonth, hasEntry, date);

                    <MudPaper Class="@classes">
                        <MudButton Variant="Variant.Text"
                                   Disabled="@(!inMonth)"
                                   Class="calendar-day-btn"
                                   OnClick="() => OpenEntry(date)">
                            @date.Day
                        </MudButton>
                    </MudPaper>
                }
            }
        </div>

    </MudPaper>
</MudContainer>

@code {
    private readonly string[] _dayHeaders = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    private DateTime _currentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private List<List<DateTime>> _weeks = new();
    private HashSet<DateTime> _entryDates = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthAsync();
    }

    private async Task LoadMonthAsync()
    {
        var monthStart = _currentMonth;
        var monthEnd = monthStart.AddMonths(1).AddDays(-1);

        _entryDates = await EntryService.GetEntryDatesInRangeAsync(monthStart, monthEnd);
        _weeks = BuildWeeks(monthStart);
    }

    private List<List<DateTime>> BuildWeeks(DateTime monthStart)
    {
        var firstOfMonth = new DateTime(monthStart.Year, monthStart.Month, 1);
        var gridStart = firstOfMonth.AddDays(-(int)firstOfMonth.DayOfWeek);
        var gridEnd = gridStart.AddDays(41);

        var weeks = new List<List<DateTime>>();
        var current = gridStart;

        while (current <= gridEnd)
        {
            var week = new List<DateTime>();
            for (var i = 0; i < 7; i++)
            {
                week.Add(current);
                current = current.AddDays(1);
            }
            weeks.Add(week);
        }

        return weeks;
    }

    private string GetCellClass(bool inMonth, bool hasEntry, DateTime date)
    {
        var classes = "calendar-cell";

        if (!inMonth)
            classes += " out-month";
        if (hasEntry)
            classes += " has-entry";
        if (IsToday(date))
            classes += " today";

        return classes;
    }

    private async Task PrevMonth()
    {
        _currentMonth = _currentMonth.AddMonths(-1);
        await LoadMonthAsync();
    }

    private async Task NextMonth()
    {
        _currentMonth = _currentMonth.AddMonths(1);
        await LoadMonthAsync();
    }

    private void OpenEntry(DateTime date)
    {
        var formatted = date.ToString("yyyy-MM-dd");
        Nav.NavigateTo($"/entry?date={formatted}");
    }

    private static bool IsToday(DateTime date) => date.Date == DateTime.Today;
}
