@page "/"
@using JournalApp.Services
@inject IJSRuntime JS

<MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>

<!-- Filters -->
<MudPaper Class="pa-4 mb-4 rounded-xl" Elevation="0" Outlined="true">
    <MudGrid Class="align-center">
        <MudItem xs="12" sm="5">
            <MudDatePicker Label="Start Date" @bind-Date="_startDate" Variant="Variant.Outlined" Margin="Margin.Dense" />
        </MudItem>
        <MudItem xs="12" sm="5">
            <MudDatePicker Label="End Date" @bind-Date="_endDate" Variant="Variant.Outlined" Margin="Margin.Dense" />
        </MudItem>
        <MudItem xs="12" sm="2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilter" FullWidth="true" Class="rounded-lg">Apply</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_analyticsSummary is null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudGrid>
        <!-- Row 1: Key Metrics -->
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 rounded-xl d-flex flex-column align-center justify-center mud-height-full" Elevation="0" Outlined="true">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Active Days</MudText>
                <MudText Typo="Typo.h3" Color="Color.Primary" Class="fw-bold">@_analyticsSummary.TotalEntries</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">days</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 rounded-xl d-flex flex-column align-center justify-center mud-height-full" Elevation="0" Outlined="true">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Current Streak</MudText>
                <MudText Typo="Typo.h3" Color="Color.Primary" Class="fw-bold">@_analyticsSummary.CurrentStreakDays</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">days</MudText>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 rounded-xl d-flex flex-column align-center justify-center mud-height-full" Elevation="0" Outlined="true">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Longest Streak</MudText>
                <MudText Typo="Typo.h3" Color="Color.Primary" Class="fw-bold">@_analyticsSummary.LongestStreakDays</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">days</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 rounded-xl d-flex flex-column align-center justify-center mud-height-full" Elevation="0" Outlined="true">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Most Frequent Mood</MudText>
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="fw-bold text-center">@_analyticsSummary.MostFrequentMood</MudText>
            </MudPaper>
        </MudItem>

        <!-- Row 2: Charts & Details -->
        
        <!-- Mood Distribution -->
        <MudItem xs="12">
            <MudPaper Class="pa-4 rounded-xl" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-4">Mood Distribution</MudText>
                @if (_analyticsSummary.MoodCategoryPercentages.Count == 0)
                {
                    <MudText Color="Color.Secondary">No mood data.</MudText>
                }
                else
                {
                    <MudGrid>
                        @foreach (var c in _analyticsSummary.MoodCategoryPercentages)
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <div class="d-flex justify-space-between mb-1">
                                    <MudText Typo="Typo.body2">@c.Category</MudText>
                                    <MudText Typo="Typo.body2" Class="fw-bold">@c.Percentage%</MudText>
                                </div>
                                <MudProgressLinear Color="Color.Primary" Value="@c.Percentage" Class="rounded-lg" Height="8" />
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudPaper>
        </MudItem>

        <!-- Word Count Trend -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4 rounded-xl" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-4">Word Count Trend</MudText>
                @if (_analyticsSummary.WordCountTrend.Count == 0)
                {
                    <MudText Color="Color.Secondary">No data available for this range.</MudText>
                }
                else
                {
                   <MudChart ChartType="ChartType.Line" ChartSeries="@WordCountSeries" XAxisLabels="@WordCountLabels" Width="100%" Height="300px"></MudChart>
                }
            </MudPaper>
        </MudItem>

        <!-- Top Tags -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4 rounded-xl mud-height-full" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-4">Top Tags</MudText>
                @if (_analyticsSummary.TagCounts.Count == 0)
                {
                    <MudText Color="Color.Secondary">No tags found.</MudText>
                }
                else
                {
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var tag in _analyticsSummary.TagCounts.Take(15))
                        {
                            <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">@tag.Name (@tag.Count)</MudChip>
                        }
                    </div>
                }
            </MudPaper>
        </MudItem>

    </MudGrid>
}

@code {
    private readonly AnalyticsService _analyticsService = new();
    private AnalyticsService.AnalyticsSummary? _analyticsSummary;
    private DateTime? _startDate = DateTime.Today.AddDays(-30);
    private DateTime? _endDate = DateTime.Today;

    // Chart Data
    public List<ChartSeries> WordCountSeries { get; set; } = new();
    public string[] WordCountLabels { get; set; } = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task ApplyFilter()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _analyticsSummary = await _analyticsService.GetSummaryAsync(
            _startDate ?? DateTime.Today.AddDays(-30),
            _endDate ?? DateTime.Today);

        if (_analyticsSummary != null)
        {
            PrepareChartData();
        }
    }

    private void PrepareChartData()
    {
        if (_analyticsSummary == null) return;

        // Populate Chart Series
        WordCountSeries = new List<ChartSeries>()
        {
            new ChartSeries() { Name = "Avg Words", Data = _analyticsSummary.WordCountTrend.Select(x => x.AverageWords).ToArray() }
        };

        // Populate Labels (simplify date for chart readability)
        // If too many points, maybe show fewer labels or simplify format
        var count = _analyticsSummary.WordCountTrend.Count;
        if (count > 0)
        {
             // Simple logic: if > 15 points, show every nth label to avoid crowding?
             // MudBlazor chart handles some crowding, but let's just pass all dates formatted nicely.
             WordCountLabels = _analyticsSummary.WordCountTrend.Select(x => x.Date.ToString("MM/dd")).ToArray();
        }
        else
        {
            WordCountLabels = Array.Empty<string>();
        }
    }
}
