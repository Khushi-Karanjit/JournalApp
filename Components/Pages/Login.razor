@page "/login"
@inject JournalApp.Services.AuthService Auth
@inject NavigationManager Nav

<MudPaper Class="surface-card auth-card">
    <MudStack Spacing="2">
        <MudText Typo="Typo.h5">Journal Login</MudText>
        <MudText Class="muted-text">
            @if (!Auth.HasAccount)
            {
                <span>Create your account</span>
            }
            else
            {
                <span>Welcome back, @Auth.Username</span>
            }
        </MudText>

        @if (!Auth.HasAccount)
        {
            <MudTextField T="string"
                          Label="Username"
                          Variant="Variant.Outlined"
                          @bind-Value="username" />
        }

        <MudTextField T="string"
                      Label="PIN"
                      Variant="Variant.Outlined"
                      InputType="InputType.Password"
                      @bind-Value="pin" />

        @if (!string.IsNullOrEmpty(error))
        {
            <MudText Color="Color.Error">@error</MudText>
        }

        <MudButton Color="Color.Primary" Variant="Variant.Filled" FullWidth="true" OnClick="Submit">
            @(!Auth.HasAccount ? "Create Account" : "Login")
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    private string username = "";
    private string pin = "";
    private string error = "";

    protected override async Task OnInitializedAsync()
    {
        await Auth.InitializeAsync();   // CRITICAL
    }

    private async Task Submit()
    {
        error = "";

        if (string.IsNullOrWhiteSpace(pin))
        {
            error = "PIN is required.";
            return;
        }

        if (!Auth.HasAccount)
        {
            if (string.IsNullOrWhiteSpace(username))
            {
                error = "Username is required.";
                return;
            }

            await Auth.RegisterAsync(username.Trim(), pin.Trim());
            Nav.NavigateTo("/", true); // or "/today" or your main page route
            return;
        }

        var ok = await Auth.LoginAsync(pin.Trim());
        if (!ok)
        {
            error = "Incorrect PIN.";
            return;
        }

        Nav.NavigateTo("/", true); // IMPORTANT: move away from login page
    }
}
