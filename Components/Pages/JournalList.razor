@page "/journal-list"
@using JournalApp.Models.Sqlite
@inject JournalApp.Services.EntryService EntryService
@inject NavigationManager Nav
@inject IJSRuntime JS

<MudText Typo="Typo.h4" Class="mb-4">Journal Entries</MudText>

<div class="d-flex justify-space-between align-center mb-3 flex-wrap gap-2">
    <MudText Color="Color.Secondary">Total: @totalCount</MudText>
    <div class="d-flex align-center gap-2">
        <MudText Typo="Typo.body2">Page Size:</MudText>
        <MudSelect T="int" Value="pageSize" ValueChanged="OnPageSizeChanged" Variant="Variant.Outlined" Margin="Margin.Dense" Style="width:80px" AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem Value="10">10</MudSelectItem>
            <MudSelectItem Value="20">20</MudSelectItem>
        </MudSelect>
    </div>
</div>

<MudPaper Class="rounded-xl" Elevation="0" Outlined="true">
    @if (entries.Count == 0)
    {
        <div class="pa-6 text-center">
            <MudText Color="Color.Secondary">No entries yet.</MudText>
        </div>
    }
    else
    {
        <MudList T="JournalEntry" Clickable="true" DisablePadding="true">
            @foreach (var e in entries)
            {
                <MudListItem OnClick="@(() => OpenEntryView(e.EntryDate))">
                    <div class="d-flex justify-space-between align-center w-100">
                        <div>
                            <MudText Typo="Typo.subtitle1" Class="fw-bold">@e.EntryDate.ToString("yyyy-MM-dd")</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">@e.Title</MudText>
                        </div>
                        <div class="d-flex gap-2">
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Secondary" OnClick="@((MouseEventArgs x) => OpenEntryView(e.EntryDate))">View</MudButton>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Error" OnClick="@((MouseEventArgs x) => DeleteEntryAsync(e.EntryDate))">Delete</MudButton>
                        </div>
                    </div>
                </MudListItem>
                <MudDivider />
            }
        </MudList>
    }
</MudPaper>

<!-- Pagination -->
<div class="d-flex justify-center align-center mt-4 gap-4">
    <MudButton Variant="Variant.Outlined" Disabled="@(currentPage <= 1)" OnClick="PrevPage">Previous</MudButton>
    <MudText Color="Color.Secondary">Page @currentPage of @totalPages</MudText>
    <MudButton Variant="Variant.Outlined" Disabled="@(currentPage >= totalPages)" OnClick="NextPage">Next</MudButton>
</div>

@code {
    private readonly List<JournalEntry> entries = new();
    private int pageSize = 10;
    private int currentPage = 1;
    private int totalPages = 1;
    private int totalCount;

    protected override async Task OnInitializedAsync()
    {
        await LoadPageAsync();
    }

    private async Task LoadPageAsync()
    {
        totalCount = await EntryService.GetEntryCountAsync();
        totalPages = Math.Max(1, (int)Math.Ceiling(totalCount / (double)pageSize));
        if (currentPage > totalPages) currentPage = totalPages;

        entries.Clear();
        entries.AddRange(await EntryService.GetPagedAsync(currentPage, pageSize));
    }

    private async Task OnPageSizeChanged(int newSize)
    {
        pageSize = newSize;
        currentPage = 1;
        await LoadPageAsync();
    }

    private async Task PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadPageAsync();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadPageAsync();
        }
    }

    private void OpenEntryView(DateTime date)
    {
        var formatted = date.ToString("yyyy-MM-dd");
        Nav.NavigateTo($"/entry?date={formatted}");
    }

    private async Task DeleteEntryAsync(DateTime date)
    {
        var confirm = await JS.InvokeAsync<bool>(
            "confirm",
            $"Delete entry for {date:yyyy-MM-dd}?");
        if (!confirm) return;

        await EntryService.DeleteByDateAsync(date);
        await LoadPageAsync();
    }
}
