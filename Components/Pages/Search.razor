@page "/search"
@using JournalApp.Models.Sqlite
@inject JournalApp.Services.EntryService EntryService
@inject JournalApp.Services.MoodService MoodService
@inject JournalApp.Services.TagService TagService
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3 class="mb-3">Journal App</h3>

<!-- Top row: Search + Filter + Sort + Button -->
<div class="row g-3 align-items-center mb-3">
    <div class="col-md-5">
        <input class="form-control"
               placeholder="Search entries..."
               @bind="searchText" />
    </div>

    <div class="col-md-3">
        <select class="form-select" @bind="moodFilterId">
            <option value="0">Filter by Mood</option>
            @foreach (var m in moods)
            {
                <option value="@m.Id">@m.Name</option>
            }
        </select>
    </div>

    <div class="col-md-2">
        <select class="form-select" @bind="sortOption">
            <option value="date_desc">Sort by Date</option>
            <option value="date_asc">Oldest First</option>
            <option value="title_asc">Title A-Z</option>
            <option value="title_desc">Title Z-A</option>
        </select>
    </div>

    <div class="col-md-2 d-grid">
        <button class="btn btn-primary" @onclick="OnSearchClicked">
            Search
        </button>
    </div>
</div>

<!-- Date Range + Tags -->
<div class="row g-3 align-items-center mb-3">
    <div class="col-md-3">
        <input type="date"
               class="form-control"
               @bind-value="startDate"
               @bind-value:format="yyyy-MM-dd" />
    </div>

    <div class="col-md-3">
        <input type="date"
               class="form-control"
               @bind-value="endDate"
               @bind-value:format="yyyy-MM-dd" />
    </div>

    <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted">Tags (@selectedTagIds.Count selected)</div>
            <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleTags">
                @(_showTags ? "Hide tags" : "Show tags")
            </button>
        </div>

        @if (_showTags)
        {
            <div class="tag-panel">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var t in allTags)
                    {
                        var selected = selectedTagIds.Contains(t.Id);

                        <button type="button"
                                class="btn btn-sm @(selected ? "btn-dark" : "btn-outline-dark")"
                                @onclick="() => ToggleTag(t.Id)">
                            @t.Name
                        </button>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Results List -->
<div class="card">
    <div class="card-body p-0">
        @if (pagedResults.Count == 0)
        {
            <div class="p-3 text-muted">No matching entries found.</div>
        }
        else
        {
            @foreach (var e in pagedResults)
            {
                <div class="d-flex align-items-center justify-content-between border-bottom p-3">
                    <div class="flex-grow-1">
                        <div class="fw-semibold">
                            @e.EntryDate.ToString("yyyy-MM-dd") - @e.Title
                        </div>
                        <div class="text-muted" style="font-size:0.9rem;">
                            Mood: @GetMoodName(e.PrimaryMoodId) Words: @CountWords(e.Content)

                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-primary"
                                @onclick="() => OpenEntry(e.EntryDate)">
                            View
                        </button>

                        <button class="btn btn-sm btn-outline-danger"
                                title="Delete"
                                @onclick="() => DeleteEntry(e.EntryDate)">
                            X
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-center align-items-center gap-3 mt-4 mb-4">
    <button class="btn btn-outline-secondary btn-sm"
            disabled="@(currentPage <= 1)"
            @onclick="PrevPage">
        Previous
    </button>

    <div class="text-muted">
        Page @currentPage of @totalPages
    </div>

    <button class="btn btn-outline-secondary btn-sm"
            disabled="@(currentPage >= totalPages)"
            @onclick="NextPage">
        Next
    </button>
</div>

@code {
    // Filters
    private string searchText = "";
    private int moodFilterId;
    private string sortOption = "date_desc";
    private DateTime? startDate;
    private DateTime? endDate;

    private readonly HashSet<int> selectedTagIds = new();

    // Mood dropdown values
    private List<Mood> moods = new();
    private Dictionary<int, string> moodNameById = new();

    // Tags
    private List<Tag> allTags = new();

    // Data
    private List<JournalEntry> pagedResults = new();

    // Pagination
    private int pageSize = 5;
    private int currentPage = 1;
    private int totalPages = 1;
    private int totalCount;
    private bool _showTags;

    protected override async Task OnInitializedAsync()
    {
        moods = await MoodService.GetAllAsync();
        moodNameById = moods.ToDictionary(m => m.Id, m => m.Name);

        allTags = await TagService.GetAllAsync();

        await RefreshResultsAsync();
    }

    private async Task OnSearchClicked()
    {
        currentPage = 1;
        await RefreshResultsAsync();
    }

    private async Task RefreshResultsAsync()
    {
        var moodIds = moodFilterId > 0 ? new List<int> { moodFilterId } : null;
        var tagIds = selectedTagIds.Count > 0 ? selectedTagIds.ToList() : null;

        totalCount = await EntryService.GetSearchCountAsync(
            searchText,
            startDate,
            endDate,
            moodIds,
            tagIds);

        totalPages = Math.Max(1, (int)Math.Ceiling(totalCount / (double)pageSize));
        if (currentPage > totalPages) currentPage = totalPages;

        pagedResults = await EntryService.SearchAsync(
            searchText,
            startDate,
            endDate,
            moodIds,
            tagIds,
            currentPage,
            pageSize,
            sortOption);
    }

    private async Task PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await RefreshResultsAsync();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await RefreshResultsAsync();
        }
    }

    private void ToggleTag(int tagId)
    {
        if (selectedTagIds.Contains(tagId))
            selectedTagIds.Remove(tagId);
        else
            selectedTagIds.Add(tagId);
    }

    private void ToggleTags()
    {
        _showTags = !_showTags;
    }

    private void OpenEntry(DateTime day)
    {
        var formatted = day.ToString("yyyy-MM-dd");
        Nav.NavigateTo($"/entry?date={formatted}");
    }

    private async Task DeleteEntry(DateTime day)
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "Delete this entry?");
        if (!confirm) return;

        await EntryService.DeleteByDateAsync(day);
        await RefreshResultsAsync();
    }

    private string GetMoodName(int moodId)
    {
        return moodNameById.TryGetValue(moodId, out var name) ? name : "-";
    }

    private static int CountWords(string? text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 0;
        return text.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;
    }
}

<style>
    .tag-panel {
        max-height: 180px;
        overflow: auto;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        background: var(--surface);
    }
</style>
